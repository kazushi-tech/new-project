name: SpecForge Requirements Review

on:
  pull_request:
    paths:
      - 'requirements/**'
    types: [opened, synchronize, reopened]

permissions:
  contents: read
  pull-requests: write
  checks: write

jobs:
  requirements-review:
    runs-on: ubuntu-latest
    steps:
      - name: Checkout
        uses: actions/checkout@v4
        with:
          fetch-depth: 0

      - name: Detect changed requirements files
        id: changed
        uses: actions/github-script@v7
        with:
          script: |
            const { data: files } = await github.rest.pulls.listFiles({
              owner: context.repo.owner,
              repo: context.repo.repo,
              pull_number: context.issue.number,
            });
            const reqFiles = files
              .filter(f => f.filename.startsWith('requirements/'))
              .filter(f => f.filename !== 'requirements/.gitkeep');
            const list = reqFiles
              .map(f => `| \`${f.filename}\` | ${f.status} | +${f.additions} -${f.deletions} |`)
              .join('\n');
            core.setOutput('count', String(reqFiles.length));
            core.setOutput('list', list);
            core.setOutput('files', reqFiles.map(f => f.filename).join(','));

      - name: Post or update review comment
        if: steps.changed.outputs.count != '0'
        uses: actions/github-script@v7
        env:
          REQ_COUNT: ${{ steps.changed.outputs.count }}
          REQ_FILE_TABLE: ${{ steps.changed.outputs.list }}
        with:
          script: |
            const marker = '<!-- specforge-review -->';
            const count = parseInt(process.env.REQ_COUNT, 10);
            const fileTable = process.env.REQ_FILE_TABLE;
            const sha = context.payload.pull_request.head.sha.substring(0, 7);
            const now = new Date().toISOString();

            const body = [
              marker,
              '## SpecForge Requirements Review',
              '',
              `> Reviewed at: ${now} (commit: \`${sha}\`)`,
              '',
              `### Changed Files (${count})`,
              '',
              '| File | Status | Changes |',
              '|------|--------|---------|',
              fileTable,
              '',
              '---',
              '',
              '### Review Summary',
              '',
              '> **MVP**: This is an automated review placeholder.',
              '> Full AI review agents will be enabled in Phase 2.',
              '',
              '#### Findings',
              '',
              '- Requirements files detected and listed above',
              '- Detailed AI review: coming in Phase 2 (multi-agent parallel review)',
              '',
              '---',
              '',
              '> **[AI proposals] are suggestions only.**',
              '> All requirements must be approved by a human CODEOWNERS reviewer.',
              '> AI will NOT approve this PR. Only `REQUEST_CHANGES` or `COMMENT` is used.',
              '',
              '| Gate | Status |',
              '|------|--------|',
              '| Requirements files detected | :white_check_mark: |',
              '| AI review (Phase 2) | :construction: Placeholder |',
              '| CODEOWNERS approval required | :lock: Pending |',
              '| `requirements-approved` label | :label: Required before merge |',
            ].join('\n');

            // Idempotent: find existing marker comment, update or create
            const { data: comments } = await github.rest.issues.listComments({
              owner: context.repo.owner,
              repo: context.repo.repo,
              issue_number: context.issue.number,
            });
            const existing = comments.find(c => c.body && c.body.includes(marker));

            if (existing) {
              await github.rest.issues.updateComment({
                owner: context.repo.owner,
                repo: context.repo.repo,
                comment_id: existing.id,
                body: body,
              });
              core.info(`Updated existing review comment (id: ${existing.id})`);
            } else {
              await github.rest.issues.createComment({
                owner: context.repo.owner,
                repo: context.repo.repo,
                issue_number: context.issue.number,
                body: body,
              });
              core.info('Created new review comment');
            }
